@page "/"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
<<<<<<< HEAD
@using SIMS.Data
=======
>>>>>>> 905b7876f8d54c8c20d55743afa6dfef9409888c
@inject IDbContextFactory<SIMS.Data.ApplicationDbContext> DbFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<SIMS.Data.ApplicationUser> UserManager

<PageTitle>Dashboard - SIMS</PageTitle>

<div class="container py-5 fade-in">

    <AuthorizeView>
<<<<<<< HEAD
=======
        <!-- TRƯỜNG HỢP 1: KHÁCH (CHƯA ĐĂNG NHẬP) -->
>>>>>>> 905b7876f8d54c8c20d55743afa6dfef9409888c
        <NotAuthorized>
            <div class="position-relative w-100 vh-100 d-flex align-items-center justify-content-center text-white overflow-hidden p-0">
                <div class="col-lg-8 text-center">
                    <div class="mb-4">
                        <div class="d-inline-flex align-items-center justify-content-center bg-white text-primary rounded-circle p-4 shadow-lg mb-4" style="width: 120px; height: 120px;">
                            <i class="bi bi-grid-1x2-fill display-3"></i>
                        </div>
                    </div>
                    <h1 class="display-4 fw-bold text-dark mb-3">Welcome to SIMS Portal</h1>
                    <p class="lead text-muted mb-5">
                        Student Information Management System.<br />
                        Please log in to access your academic dashboard.
                    </p>
                    <div class="d-flex justify-content-center gap-3">
                        <a href="Account/Login" class="btn btn-gradient-primary btn-lg px-5 rounded-pill shadow-lg">
                            <i class="bi bi-box-arrow-in-right me-2"></i>Log In
                        </a>
                        <a href="Account/Register" class="btn btn-outline-primary btn-lg px-5 rounded-pill">
                            Register
                        </a>
                    </div>
                </div>
            </div>
        </NotAuthorized>

<<<<<<< HEAD
        <Authorized>
            <div class="mb-5 d-flex align-items-center">
                @if (currentUser != null)
                {
                    <div class="me-4">
                        @if (!string.IsNullOrEmpty(currentUser.Avatar))
                        {
                            <img src="@currentUser.Avatar" alt="Avatar" class="rounded-circle shadow-sm border border-3 border-white"
                                 style="width: 80px; height: 80px; object-fit: cover;" />
                        }
                        else
                        {
                            <div class="bg-soft-primary text-primary rounded-circle d-flex align-items-center justify-content-center shadow-sm border border-3 border-white"
                                 style="width: 80px; height: 80px; font-size: 2rem; font-weight: bold;">
                                @(string.IsNullOrEmpty(currentUser.Name) ? "?" : currentUser.Name.Substring(0, 1).ToUpper())
                            </div>
                        }
                    </div>
                }

                <div>
                    <h1 class="fw-bold text-dark display-5 mb-1">
                        Hello, <span class="text-primary">@(currentUser?.Name ?? context.User.Identity?.Name)</span>
                    </h1>
                    <p class="text-muted fs-5 mb-0">Here's your academic overview for today.</p>
                </div>
            </div>

            <AuthorizeView Roles="Admin" Context="adminCtx">
=======
        <!-- KHI ĐÃ ĐĂNG NHẬP -->
        <Authorized>
            <!-- Header Chung -->
            <div class="mb-5">
                <h1 class="fw-bold text-dark display-5">
                    Hello, <span class="text-primary">@context.User.Identity?.Name</span>
                </h1>
                <p class="text-muted fs-5">Here's your academic overview for today.</p>
            </div>

            <!-- ================================================================================== -->
            <!-- TRƯỜNG HỢP 2: ADMIN (Sử dụng lại code gốc của bạn) -->
            <!-- ================================================================================== -->
            <AuthorizeView Roles="Admin" Context="adminCtx">
                <!-- Stats Row -->
>>>>>>> 905b7876f8d54c8c20d55743afa6dfef9409888c
                <div class="row g-4 mb-5">
                    <div class="col-md-6 col-xl-3">
                        <div class="card border-0 shadow-sm h-100 overflow-hidden card-hover">
                            <div class="card-body p-4 d-flex align-items-center justify-content-between">
                                <div><p class="text-muted fw-bold text-uppercase small mb-1">Total Users</p><h2 class="fw-bold mb-0 text-dark">@adminStats.UserCount</h2></div>
                                <div class="bg-soft-primary text-primary rounded-circle p-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;"><i class="bi bi-people-fill fs-3"></i></div>
                            </div>
                            <div class="progress" style="height: 4px;"><div class="progress-bar bg-primary" style="width: 70%"></div></div>
                        </div>
                    </div>
                    <div class="col-md-6 col-xl-3">
                        <div class="card border-0 shadow-sm h-100 overflow-hidden card-hover">
                            <div class="card-body p-4 d-flex align-items-center justify-content-between">
                                <div><p class="text-muted fw-bold text-uppercase small mb-1">Active Courses</p><h2 class="fw-bold mb-0 text-dark">@adminStats.CourseCount</h2></div>
                                <div class="bg-soft-success text-success rounded-circle p-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;"><i class="bi bi-journal-bookmark-fill fs-3"></i></div>
                            </div>
                            <div class="progress" style="height: 4px;"><div class="progress-bar bg-success" style="width: 55%"></div></div>
                        </div>
                    </div>
                    <div class="col-md-6 col-xl-3">
                        <div class="card border-0 shadow-sm h-100 overflow-hidden card-hover">
                            <div class="card-body p-4 d-flex align-items-center justify-content-between">
                                <div><p class="text-muted fw-bold text-uppercase small mb-1">Departments</p><h2 class="fw-bold mb-0 text-dark">@adminStats.DeptCount</h2></div>
                                <div class="bg-soft-danger text-danger rounded-circle p-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;"><i class="bi bi-buildings-fill fs-3"></i></div>
                            </div>
                            <div class="progress" style="height: 4px;"><div class="progress-bar bg-danger" style="width: 40%"></div></div>
                        </div>
                    </div>
                    <div class="col-md-6 col-xl-3">
                        <div class="card border-0 shadow-sm h-100 overflow-hidden card-hover">
                            <div class="card-body p-4 d-flex align-items-center justify-content-between">
                                <div><p class="text-muted fw-bold text-uppercase small mb-1">Subjects</p><h2 class="fw-bold mb-0 text-dark">@adminStats.SubjectCount</h2></div>
                                <div class="bg-soft-warning text-warning rounded-circle p-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;"><i class="bi bi-collection-fill fs-3"></i></div>
                            </div>
                            <div class="progress" style="height: 4px;"><div class="progress-bar bg-warning" style="width: 85%"></div></div>
                        </div>
                    </div>
                </div>

                <h4 class="fw-bold text-secondary mb-3">System Management</h4>
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="card border-0 shadow-lg rounded-4 overflow-hidden h-100">
                            <div class="card-header bg-white border-0 pt-4 px-4"><h5 class="fw-bold text-primary mb-0"><i class="bi bi-gear-wide-connected me-2"></i>Administration</h5></div>
                            <div class="card-body p-4">
                                <div class="row g-3">
                                    <div class="col-md-4"><a href="users" class="text-decoration-none"><div class="p-3 border rounded-3 bg-light hover-bg-white text-center h-100 d-flex flex-column align-items-center justify-content-center transition-all"><i class="bi bi-people-fill fs-3"></i><span class="fw-bold text-dark">Users</span></div></a></div>
                                    <div class="col-md-4"><a href="semesters" class="text-decoration-none"><div class="p-3 border rounded-3 bg-light hover-bg-white text-center h-100 d-flex flex-column align-items-center justify-content-center transition-all"><i class="bi bi-calendar-week fs-1 text-success mb-2"></i><span class="fw-bold text-dark">Semesters</span></div></a></div>
                                    <div class="col-md-4"><a href="departments" class="text-decoration-none"><div class="p-3 border rounded-3 bg-light hover-bg-white text-center h-100 d-flex flex-column align-items-center justify-content-center transition-all"><i class="bi bi-buildings fs-1 text-danger mb-2"></i><span class="fw-bold text-dark">Departments</span></div></a></div>
                                    <div class="col-md-4"><a href="majors" class="text-decoration-none"><div class="p-3 border rounded-3 bg-light hover-bg-white text-center h-100 d-flex flex-column align-items-center justify-content-center transition-all"><i class="bi bi-mortarboard fs-1 text-warning mb-2"></i><span class="fw-bold text-dark">Majors</span></div></a></div>
                                    <div class="col-md-4"><a href="subjects" class="text-decoration-none"><div class="p-3 border rounded-3 bg-light hover-bg-white text-center h-100 d-flex flex-column align-items-center justify-content-center transition-all"><i class="bi bi-collection fs-1 text-info mb-2"></i><span class="fw-bold text-dark">Subjects</span></div></a></div>
                                    <div class="col-md-4"><a href="courses" class="text-decoration-none"><div class="p-3 border rounded-3 bg-light hover-bg-white text-center h-100 d-flex flex-column align-items-center justify-content-center transition-all"><i class="bi bi-journal-text fs-1 text-dark mb-2"></i><span class="fw-bold text-dark">Courses</span></div></a></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card border-0 shadow-lg rounded-4 overflow-hidden h-100 bg-gradient-primary text-white">
                            <div class="card-body p-4 d-flex flex-column justify-content-center align-items-center text-center">
                                <div class="bg-white text-primary rounded-circle p-4 mb-3 shadow-sm"><i class="bi bi-shield-lock-fill fs-1"></i></div>
                                <h4 class="fw-bold">Admin Profile</h4>
                                <p class="opacity-75 mb-4">System Administrator access granted.</p>
                                <a href="profile" class="btn btn-light text-primary fw-bold rounded-pill px-4 py-2 shadow-sm w-100">Edit Profile</a>
                            </div>
                        </div>
                    </div>
                </div>
            </AuthorizeView>

<<<<<<< HEAD
            <AuthorizeView Roles="Lecture" Context="lectureCtx">
=======
            <!-- ================================================================================== -->
            <!-- TRƯỜNG HỢP 3: LECTURE (GIẢNG VIÊN) -->
            <!-- ================================================================================== -->
            <AuthorizeView Roles="Lecture" Context="lectureCtx">
                <!-- Stats Row -->
>>>>>>> 905b7876f8d54c8c20d55743afa6dfef9409888c
                <div class="row g-4 mb-5">
                    <div class="col-md-6 col-xl-3">
                        <div class="card border-0 shadow-sm h-100 overflow-hidden card-hover">
                            <div class="card-body p-4 d-flex align-items-center justify-content-between">
                                <div><p class="text-muted fw-bold text-uppercase small mb-1">My Courses</p><h2 class="fw-bold mb-0 text-dark">@lectureStats.MyCourses</h2></div>
                                <div class="bg-soft-primary text-primary rounded-circle p-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;"><i class="bi bi-journal-richtext fs-3"></i></div>
                            </div>
                            <div class="progress" style="height: 4px;"><div class="progress-bar bg-primary" style="width: 100%"></div></div>
                        </div>
                    </div>
                    <div class="col-md-6 col-xl-3">
                        <div class="card border-0 shadow-sm h-100 overflow-hidden card-hover">
                            <div class="card-body p-4 d-flex align-items-center justify-content-between">
                                <div><p class="text-muted fw-bold text-uppercase small mb-1">Total Students</p><h2 class="fw-bold mb-0 text-dark">@lectureStats.TotalStudents</h2></div>
                                <div class="bg-soft-success text-success rounded-circle p-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;"><i class="bi bi-people fs-3"></i></div>
                            </div>
                            <div class="progress" style="height: 4px;"><div class="progress-bar bg-success" style="width: 75%"></div></div>
                        </div>
                    </div>
                    <div class="col-md-6 col-xl-3">
                        <div class="card border-0 shadow-sm h-100 overflow-hidden card-hover">
                            <div class="card-body p-4 d-flex align-items-center justify-content-between">
                                <div><p class="text-muted fw-bold text-uppercase small mb-1">Hours Taught</p><h2 class="fw-bold mb-0 text-dark">45</h2></div>
                                <div class="bg-soft-danger text-danger rounded-circle p-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;"><i class="bi bi-clock-history fs-3"></i></div>
                            </div>
                            <div class="progress" style="height: 4px;"><div class="progress-bar bg-danger" style="width: 50%"></div></div>
                        </div>
                    </div>
                    <div class="col-md-6 col-xl-3">
                        <div class="card border-0 shadow-sm h-100 overflow-hidden card-hover">
                            <div class="card-body p-4 d-flex align-items-center justify-content-between">
                                <div><p class="text-muted fw-bold text-uppercase small mb-1">Grading</p><h2 class="fw-bold mb-0 text-dark">Pending</h2></div>
                                <div class="bg-soft-warning text-warning rounded-circle p-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;"><i class="bi bi-pencil-square fs-3"></i></div>
                            </div>
                            <div class="progress" style="height: 4px;"><div class="progress-bar bg-warning" style="width: 30%"></div></div>
                        </div>
                    </div>
                </div>

                <h4 class="fw-bold text-secondary mb-3">Teaching Tools</h4>
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="card border-0 shadow-lg rounded-4 overflow-hidden h-100">
                            <div class="card-header bg-white border-0 pt-4 px-4"><h5 class="fw-bold text-primary mb-0"><i class="bi bi-easel me-2"></i>Classroom Management</h5></div>
                            <div class="card-body p-4">
                                <div class="row g-3">
<<<<<<< HEAD
=======
                                    <!-- Giảng viên chỉ xem lớp của mình -->
>>>>>>> 905b7876f8d54c8c20d55743afa6dfef9409888c
                                    <div class="col-md-6"><a href="my-courses" class="text-decoration-none"><div class="p-3 border rounded-3 bg-light hover-bg-white text-center h-100 d-flex flex-column align-items-center justify-content-center transition-all"><i class="bi bi-journal-check fs-1 text-primary mb-2"></i><span class="fw-bold text-dark">My Courses & Students</span></div></a></div>
                                    <div class="col-md-6"><a href="#" class="text-decoration-none"><div class="p-3 border rounded-3 bg-light hover-bg-white text-center h-100 d-flex flex-column align-items-center justify-content-center transition-all"><i class="bi bi-calendar3 fs-1 text-success mb-2"></i><span class="fw-bold text-dark">Teaching Schedule</span></div></a></div>
                                    <div class="col-md-6"><a href="#" class="text-decoration-none"><div class="p-3 border rounded-3 bg-light hover-bg-white text-center h-100 d-flex flex-column align-items-center justify-content-center transition-all"><i class="bi bi-graph-up-arrow fs-1 text-warning mb-2"></i><span class="fw-bold text-dark">Input Grades</span></div></a></div>
                                    <div class="col-md-6"><a href="#" class="text-decoration-none"><div class="p-3 border rounded-3 bg-light hover-bg-white text-center h-100 d-flex flex-column align-items-center justify-content-center transition-all"><i class="bi bi-clipboard-data fs-1 text-info mb-2"></i><span class="fw-bold text-dark">Reports</span></div></a></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card border-0 shadow-lg rounded-4 overflow-hidden h-100 bg-gradient-primary text-white">
                            <div class="card-body p-4 d-flex flex-column justify-content-center align-items-center text-center">
                                <div class="bg-white text-primary rounded-circle p-4 mb-3 shadow-sm"><i class="bi bi-person-badge fs-1"></i></div>
                                <h4 class="fw-bold">Lecturer Profile</h4>
                                <p class="opacity-75 mb-4">Manage your teaching profile and availability.</p>
                                <a href="profile" class="btn btn-light text-primary fw-bold rounded-pill px-4 py-2 shadow-sm w-100">View Profile</a>
                            </div>
                        </div>
                    </div>
                </div>
            </AuthorizeView>

<<<<<<< HEAD
            <AuthorizeView Roles="Student" Context="studentCtx">
=======
            <!-- ================================================================================== -->
            <!-- TRƯỜNG HỢP 4: STUDENT (SINH VIÊN) -->
            <!-- ================================================================================== -->
            <AuthorizeView Roles="Student" Context="studentCtx">
                <!-- Stats Row -->
>>>>>>> 905b7876f8d54c8c20d55743afa6dfef9409888c
                <div class="row g-4 mb-5">
                    <div class="col-md-6 col-xl-3">
                        <div class="card border-0 shadow-sm h-100 overflow-hidden card-hover">
                            <div class="card-body p-4 d-flex align-items-center justify-content-between">
                                <div><p class="text-muted fw-bold text-uppercase small mb-1">Enrolled</p><h2 class="fw-bold mb-0 text-dark">@studentStats.EnrolledCourses</h2></div>
                                <div class="bg-soft-primary text-primary rounded-circle p-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;"><i class="bi bi-book-half fs-3"></i></div>
                            </div>
                            <div class="progress" style="height: 4px;"><div class="progress-bar bg-primary" style="width: 60%"></div></div>
                        </div>
                    </div>
                    <div class="col-md-6 col-xl-3">
                        <div class="card border-0 shadow-sm h-100 overflow-hidden card-hover">
                            <div class="card-body p-4 d-flex align-items-center justify-content-between">
                                <div><p class="text-muted fw-bold text-uppercase small mb-1">Credits</p><h2 class="fw-bold mb-0 text-dark">12</h2></div>
                                <div class="bg-soft-success text-success rounded-circle p-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;"><i class="bi bi-check-circle-fill fs-3"></i></div>
                            </div>
                            <div class="progress" style="height: 4px;"><div class="progress-bar bg-success" style="width: 80%"></div></div>
                        </div>
                    </div>
                    <div class="col-md-6 col-xl-3">
                        <div class="card border-0 shadow-sm h-100 overflow-hidden card-hover">
                            <div class="card-body p-4 d-flex align-items-center justify-content-between">
                                <div><p class="text-muted fw-bold text-uppercase small mb-1">GPA</p><h2 class="fw-bold mb-0 text-dark">3.5</h2></div>
                                <div class="bg-soft-warning text-warning rounded-circle p-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;"><i class="bi bi-star-fill fs-3"></i></div>
                            </div>
                            <div class="progress" style="height: 4px;"><div class="progress-bar bg-warning" style="width: 90%"></div></div>
                        </div>
                    </div>
                    <div class="col-md-6 col-xl-3">
                        <div class="card border-0 shadow-sm h-100 overflow-hidden card-hover">
                            <div class="card-body p-4 d-flex align-items-center justify-content-between">
                                <div><p class="text-muted fw-bold text-uppercase small mb-1">Attendance</p><h2 class="fw-bold mb-0 text-dark">95%</h2></div>
                                <div class="bg-soft-danger text-danger rounded-circle p-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;"><i class="bi bi-calendar-check-fill fs-3"></i></div>
                            </div>
                            <div class="progress" style="height: 4px;"><div class="progress-bar bg-danger" style="width: 95%"></div></div>
                        </div>
                    </div>
                </div>

                <h4 class="fw-bold text-secondary mb-3">Learning Dashboard</h4>
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="card border-0 shadow-lg rounded-4 overflow-hidden h-100">
                            <div class="card-header bg-white border-0 pt-4 px-4"><h5 class="fw-bold text-primary mb-0"><i class="bi bi-backpack2 me-2"></i>My Studies</h5></div>
                            <div class="card-body p-4">
                                <div class="row g-3">
                                    <div class="col-md-6"><a href="my-enrollments" class="text-decoration-none"><div class="p-3 border rounded-3 bg-light hover-bg-white text-center h-100 d-flex flex-column align-items-center justify-content-center transition-all"><i class="bi bi-journal-text fs-1 text-primary mb-2"></i><span class="fw-bold text-dark">My Class List</span></div></a></div>
                                    <div class="col-md-6"><a href="#" class="text-decoration-none"><div class="p-3 border rounded-3 bg-light hover-bg-white text-center h-100 d-flex flex-column align-items-center justify-content-center transition-all"><i class="bi bi-grid-3x3 fs-1 text-success mb-2"></i><span class="fw-bold text-dark">Timetable</span></div></a></div>
                                    <div class="col-md-6"><a href="#" class="text-decoration-none"><div class="p-3 border rounded-3 bg-light hover-bg-white text-center h-100 d-flex flex-column align-items-center justify-content-center transition-all"><i class="bi bi-trophy fs-1 text-warning mb-2"></i><span class="fw-bold text-dark">View Grades</span></div></a></div>
                                    <div class="col-md-6"><a href="#" class="text-decoration-none"><div class="p-3 border rounded-3 bg-light hover-bg-white text-center h-100 d-flex flex-column align-items-center justify-content-center transition-all"><i class="bi bi-file-earmark-text fs-1 text-info mb-2"></i><span class="fw-bold text-dark">Exam Schedule</span></div></a></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card border-0 shadow-lg rounded-4 overflow-hidden h-100 bg-gradient-primary text-white">
                            <div class="card-body p-4 d-flex flex-column justify-content-center align-items-center text-center">
                                <div class="bg-white text-primary rounded-circle p-4 mb-3 shadow-sm"><i class="bi bi-person-circle fs-1"></i></div>
                                <h4 class="fw-bold">Student Profile</h4>
                                <p class="opacity-75 mb-4">View and edit your personal information.</p>
                                <a href="profile" class="btn btn-light text-primary fw-bold rounded-pill px-4 py-2 shadow-sm w-100">My Profile</a>
                            </div>
                        </div>
                    </div>
                </div>
            </AuthorizeView>

        </Authorized>
    </AuthorizeView>
</div>

@code {
<<<<<<< HEAD
=======
    /*
    Pseudocode / Plan (detailed):
    1. Inject UserManager<ApplicationUser> so we can obtain the full ApplicationUser entity (and its Id).
       - Use the ClaimsPrincipal from the authentication state to call UserManager.GetUserAsync(principal).
    2. On component initialization:
       - Await the cascading AuthenticationState task to get the current user principal.
       - If authenticated:
         a) Use UserManager.GetUserAsync(principal) to fetch the ApplicationUser instance (may be null).
         b) Create a DbContext from the injected IDbContextFactory to perform queries.
         c) Based on the user's roles (Admin / Lecture / Student) run role-specific queries:
            - Admin: count Users, Courses, Departments, Subjects.
            - Lecture: use appUser.Id to filter Courses.LectureId and Enrollments.CourseId.
            - Student: use appUser.Id to count Enrollments.StudentId.
       - Ensure null checks: if UserManager returns null or no matching records, set stats to 0.
       - Dispose the DbContext (using statement) after queries.
    3. Keep DTO classes local and bind their properties to the UI.
    4. Handle cases where tables (e.g., Subjects) might not exist by defensive coding (left as-is if present).
    */

>>>>>>> 905b7876f8d54c8c20d55743afa6dfef9409888c
    // DTOs để chứa dữ liệu thống kê
    private class AdminStats
    {
        public int UserCount { get; set; }
        public int CourseCount { get; set; }
        public int DeptCount { get; set; }
        public int SubjectCount { get; set; }
    }

    private class LectureStats
    {
        public int MyCourses { get; set; }
        public int TotalStudents { get; set; }
    }

    private class StudentStats
    {
        public int EnrolledCourses { get; set; }
    }

    private AdminStats adminStats = new();
    private LectureStats lectureStats = new();
    private StudentStats studentStats = new();

<<<<<<< HEAD
    // Thêm biến để lưu thông tin user đầy đủ (bao gồm Avatar, Name)
    private ApplicationUser? currentUser;

=======
>>>>>>> 905b7876f8d54c8c20d55743afa6dfef9409888c
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }

    protected override async Task OnInitializedAsync()
    {
        // 1. Lấy thông tin User đang đăng nhập
        var authState = await authenticationStateTask;
        var user = authState.User;

        if (user.Identity is not null && user.Identity.IsAuthenticated)
        {
<<<<<<< HEAD
            // Lấy thông tin chi tiết (ApplicationUser) để lấy ID và Avatar
            currentUser = await UserManager.GetUserAsync(user);
            var appUser = currentUser; // Gán vào biến cục bộ để dùng cho logic phía dưới
=======
            // Lấy thông tin chi tiết (ApplicationUser) để lấy ID
            // Use injected UserManager to retrieve the ApplicationUser instance from the ClaimsPrincipal.
            var appUser = await UserManager.GetUserAsync(user);
>>>>>>> 905b7876f8d54c8c20d55743afa6dfef9409888c

            // Khởi tạo DbContext (dùng using để tự động dispose sau khi query xong)
            using var context = DbFactory.CreateDbContext();

            // ============================================================
            // 1. ADMIN LOGIC
            // ============================================================
            if (user.IsInRole("Admin"))
            {
                adminStats.UserCount = await context.Users.CountAsync();
                adminStats.CourseCount = await context.Courses.CountAsync();
                adminStats.DeptCount = await context.Departments.CountAsync();
<<<<<<< HEAD
                // Giả sử bạn có bảng Subjects
=======
                // Giả sử bạn có bảng Subjects, nếu chưa có thì bỏ dòng này hoặc thay bằng bảng khác
>>>>>>> 905b7876f8d54c8c20d55743afa6dfef9409888c
                adminStats.SubjectCount = await context.Subjects.CountAsync();
            }

            // ============================================================
            // 2. LECTURE LOGIC
            // ============================================================
            if (user.IsInRole("Lecture") && appUser != null)
            {
<<<<<<< HEAD
=======
                // A. Đếm số lớp giảng viên được phân công
                // Giả định: Bảng Course có trường LectureId lưu ID của giảng viên
>>>>>>> 905b7876f8d54c8c20d55743afa6dfef9409888c
                lectureStats.MyCourses = await context.Courses
                    .Where(c => c.LectureId == appUser.Id)
                    .CountAsync();

<<<<<<< HEAD
=======
                // B. Đếm tổng số sinh viên (Enrollments) trong các lớp này
                // Bước 1: Lấy danh sách ID các khóa học do giảng viên này dạy
>>>>>>> 905b7876f8d54c8c20d55743afa6dfef9409888c
                var myCourseIds = await context.Courses
                    .Where(c => c.LectureId == appUser.Id)
                    .Select(c => c.Id)
                    .ToListAsync();

<<<<<<< HEAD
=======
                // Bước 2: Đếm số lượng enrollment thuộc các khóa học đó
>>>>>>> 905b7876f8d54c8c20d55743afa6dfef9409888c
                if (myCourseIds.Any())
                {
                    lectureStats.TotalStudents = await context.Enrollments
                        .Where(e => myCourseIds.Contains(e.CourseId))
                        .CountAsync();
                }
                else
                {
                    lectureStats.TotalStudents = 0;
                }
            }

            // ============================================================
            // 3. STUDENT LOGIC
            // ============================================================
            if (user.IsInRole("Student") && appUser != null)
            {
<<<<<<< HEAD
=======
                // Đếm số môn học sinh viên đã đăng ký
                // Giả định: Bảng Enrollment có trường StudentId
>>>>>>> 905b7876f8d54c8c20d55743afa6dfef9409888c
                studentStats.EnrolledCourses = await context.Enrollments
                    .Where(e => e.StudentId == appUser.Id)
                    .CountAsync();
            }
        }
    }
}