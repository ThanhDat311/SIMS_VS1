@page "/my-courses"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Authorization
@using SIMS.Data
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Lecture")]
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager

<PageTitle>My Teaching Schedule</PageTitle>

<div class="container py-5 fade-in">
    <!-- Header Section -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-5">
        <div>
            <h2 class="fw-bold text-primary mb-1">
                <i class="bi bi-easel2-fill me-2"></i>My Teaching Schedule
            </h2>
            <p class="text-muted mb-0">Manage your assigned classes and student lists.</p>
        </div>
        <div class="mt-3 mt-md-0">
            <span class="badge bg-light text-secondary border px-3 py-2 rounded-pill shadow-sm">
                <i class="bi bi-calendar-event me-2"></i>Current Semester
            </span>
        </div>
    </div>

    @if (IsLoading)
    {
        <!-- Skeleton Loading State -->
        <div class="row g-4">
            @for (int i = 0; i < 3; i++)
            {
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="card h-100 border-0 shadow-sm rounded-4 overflow-hidden">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between mb-4">
                                <div class="skeleton rounded-3" style="width: 50px; height: 50px;"></div>
                                <div class="skeleton rounded-pill" style="width: 80px; height: 24px;"></div>
                            </div>
                            <div class="skeleton mb-2 rounded" style="width: 70%; height: 20px;"></div>
                            <div class="skeleton mb-4 rounded" style="width: 40%; height: 16px;"></div>
                            <div class="skeleton rounded-pill mt-auto" style="width: 100%; height: 40px;"></div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else if (!Courses.Any())
    {
        <!-- Empty State -->
        <div class="card border-0 shadow-sm rounded-4 bg-light py-5 text-center">
            <div class="card-body">
                <div class="mb-3">
                    <i class="bi bi-calendar-x text-muted opacity-25" style="font-size: 4rem;"></i>
                </div>
                <h5 class="fw-bold text-secondary">No Classes Assigned</h5>
                <p class="text-muted mb-0">You don't have any teaching schedule for this semester yet.</p>
            </div>
        </div>
    }
    else
    {
        <!-- Stats Overview -->
        <div class="row g-3 mb-5">
            <div class="col-md-6">
                <div class="card border-0 bg-primary text-white shadow-lg rounded-4 p-3 h-100 position-relative overflow-hidden">
                    <div class="card-body position-relative z-1 d-flex align-items-center justify-content-between">
                        <div>
                            <div class="small text-white-50 fw-bold text-uppercase mb-1">Total Classes</div>
                            <h2 class="mb-0 fw-bold display-6">@Courses.Count</h2>
                        </div>
                        <div class="bg-white bg-opacity-25 rounded-circle p-3">
                            <i class="bi bi-book fs-3 text-white"></i>
                        </div>
                    </div>
                    <i class="bi bi-book position-absolute top-50 start-0 translate-middle text-white opacity-10" style="font-size: 8rem;"></i>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-0 bg-success text-white shadow-lg rounded-4 p-3 h-100 position-relative overflow-hidden">
                    <div class="card-body position-relative z-1 d-flex align-items-center justify-content-between">
                        <div>
                            <div class="small text-white-50 fw-bold text-uppercase mb-1">Total Students</div>
                            <h2 class="mb-0 fw-bold display-6">@CourseEnrollmentCounts.Values.Sum()</h2>
                        </div>
                        <div class="bg-white bg-opacity-25 rounded-circle p-3">
                            <i class="bi bi-people fs-3 text-white"></i>
                        </div>
                    </div>
                    <i class="bi bi-people position-absolute top-50 start-0 translate-middle text-white opacity-10" style="font-size: 8rem;"></i>
                </div>
            </div>
        </div>

        <!-- Course Grid -->
        <div class="row g-4">
            @foreach (var course in Courses)
            {
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="card h-100 border-0 shadow-sm rounded-4 hover-lift transition course-card">
                        <!-- Card Header Decoration -->
                        <div class="position-absolute top-0 end-0 p-3 opacity-10">
                            <i class="bi bi-mortarboard-fill text-primary" style="font-size: 5rem; margin-right: -1rem; margin-top: -1rem;"></i>
                        </div>

                        <div class="card-body p-4 d-flex flex-column">
                            <!-- Top Info -->
                            <div class="d-flex justify-content-between align-items-start mb-3 position-relative z-1">
                                <div class="bg-gradient-primary text-white rounded-3 shadow-sm d-flex align-items-center justify-content-center p-3" style="width: 56px; height: 56px;">
                                    <span class="fw-bold fs-5">@course.Subject?.Code?.Substring(0, Math.Min(2, course.Subject?.Code?.Length ?? 0))</span>
                                </div>
                                <span class="badge bg-light text-secondary border rounded-pill px-3 py-2">
                                    @course.Semester?.Name
                                </span>
                            </div>

                            <!-- Course Title -->
                            <h5 class="fw-bold text-dark mb-2 text-truncate-2" title="@course.Name">
                                @course.Name
                            </h5>

                            <div class="text-muted small mb-4">
                                <i class="bi bi-upc-scan me-1 text-primary"></i> @course.Subject?.Code
                            </div>

                            <!-- Bottom Stats & Action -->
                            <div class="mt-auto pt-3 border-top border-light">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="d-flex align-items-center text-muted small">
                                        <i class="bi bi-people-fill me-2 text-success"></i>
                                        <span class="fw-bold text-dark me-1">@CourseEnrollmentCounts[course.Id]</span> students
                                    </span>
                                </div>

                                <a href="@($"courses/details?id={course.Id}")" class="btn btn-outline-primary w-100 rounded-pill fw-bold border-2 hover-fill">
                                    Manage Class <i class="bi bi-arrow-right ms-1"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
    /* Styling */
    .bg-gradient-primary {
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
    }

    .hover-lift {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 1rem 3rem rgba(0,0,0,.15) !important;
        }

    .hover-fill:hover {
        background-color: #4e73df;
        color: white;
        border-color: #4e73df;
    }

    .opacity-10 {
        opacity: 0.1;
    }

    .text-truncate-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* Skeleton Animation */
    .skeleton {
        background: #e0e0e0;
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
    }
</style>


@code {
    private List<Course> Courses { get; set; } = new();
    private Dictionary<int, int> CourseEnrollmentCounts { get; set; } = new();
    private bool IsLoading { get; set; } = true;

    protected override async Task OnInitializedAsync()
    {
        // Simulate slight delay to show skeleton (optional)
        // await Task.Delay(500);

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var currentUser = await UserManager.GetUserAsync(user);
            if (currentUser != null)
            {
                using var context = DbFactory.CreateDbContext();

                // Fetch assigned courses
                Courses = await context.Courses
                    .Include(c => c.Subject)
                    .Include(c => c.Semester)
                    .Where(c => c.LectureId == currentUser.Id)
                    .OrderByDescending(c => c.Id)
                    .AsNoTracking()
                    .ToListAsync();

                // Count enrollments for each course efficiently
                foreach (var course in Courses)
                {
                    var count = await context.Enrollments
                        .Where(e => e.CourseId == course.Id)
                        .CountAsync();
                    CourseEnrollmentCounts[course.Id] = count;
                }
            }
        }

        IsLoading = false;
    }
}