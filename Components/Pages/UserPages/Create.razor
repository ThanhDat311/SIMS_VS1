@page "/users/create"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using SIMS.Data
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject NavigationManager NavigationManager

<PageTitle>Create User</PageTitle>

<div class="container py-5 fade-in">
    <div class="row justify-content-center">
        <div class="col-lg-8">

            <!-- Header Section -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold text-primary mb-0">
                        <i class="bi bi-person-plus-fill me-2"></i>Create New User
                    </h2>
                    <p class="text-muted mb-0">Register a new student or staff member.</p>
                </div>
                <a href="/users" class="btn btn-outline-secondary rounded-pill px-3">
                    <i class="bi bi-arrow-left me-1"></i> Back to List
                </a>
            </div>

            <!-- Form Card -->
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
                <div class="card-body p-4 p-md-5">

                    <EditForm Model="Input" OnValidSubmit="CreateUser" FormName="create-user" method="post" Enhance>
                        <DataAnnotationsValidator />

                        <div class="mb-4">
                            <ValidationSummary class="text-danger alert alert-danger border-0 bg-soft-danger" role="alert" />
                        </div>

                        <div class="row g-3">
                            <!-- Email -->
                            <div class="col-12">
                                <label class="form-label fw-bold text-secondary small">Email Address <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-end-0 text-muted"><i class="bi bi-envelope"></i></span>
                                    <InputText @bind-Value="Input.Email" class="form-control form-control-lg bg-light border-start-0" placeholder="name@example.com" />
                                </div>
                                <ValidationMessage For="() => Input.Email" class="text-danger small mt-1" />
                            </div>

                            <!-- Password -->
                            <div class="col-12">
                                <label class="form-label fw-bold text-secondary small">Password <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-end-0 text-muted"><i class="bi bi-key"></i></span>
                                    <InputText type="password" @bind-Value="Input.Password" class="form-control form-control-lg bg-light border-start-0" placeholder="Default password..." />
                                </div>
                                <ValidationMessage For="() => Input.Password" class="text-danger small mt-1" />
                            </div>

                            <!-- Full Name -->
                            <div class="col-md-12">
                                <label class="form-label fw-bold text-secondary small">Full Name</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-end-0 text-muted"><i class="bi bi-person"></i></span>
                                    <InputText @bind-Value="Input.Name" class="form-control form-control-lg bg-light border-start-0" placeholder="e.g. Nguyen Van A" />
                                </div>
                                <ValidationMessage For="() => Input.Name" class="text-danger small mt-1" />
                            </div>

                            <!-- Student ID -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-secondary small">Student ID</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-end-0 text-muted"><i class="bi bi-card-heading"></i></span>
                                    <InputText @bind-Value="Input.StudentId" class="form-control form-control-lg bg-light border-start-0 font-monospace" placeholder="e.g. 21000123" />
                                </div>
                                <ValidationMessage For="() => Input.StudentId" class="text-danger small mt-1" />
                            </div>

                            <!-- Role Selection -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-secondary small">Assign Role</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-end-0 text-muted"><i class="bi bi-shield-lock"></i></span>
                                    <InputSelect @bind-Value="Input.Role" class="form-select form-select-lg bg-light border-start-0">
                                        <option value="">-- Select a role --</option>
                                        @foreach (var r in Roles)
                                        {
                                            <option value="@r">@r</option>
                                        }
                                    </InputSelect>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-end gap-2 mt-5">
                            <a href="/users" class="btn btn-light btn-lg px-4 rounded-pill">Cancel</a>
                            <button type="submit" class="btn btn-gradient-primary btn-lg px-4 rounded-pill shadow-sm">
                                <i class="bi bi-check-lg me-2"></i>Create User
                            </button>
                        </div>

                    </EditForm>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    /* Custom styles specific to this page */
    .bg-soft-danger {
        background-color: rgba(220, 53, 69, 0.1);
    }

    .input-group-text {
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }

    .form-control:focus, .form-select:focus {
        border-color: #86b7fe;
        box-shadow: none;
        background-color: #fff !important;
    }

    /* Focus effect for input group */
    .input-group:focus-within .input-group-text {
        border-color: #86b7fe;
        background-color: #fff !important;
        color: #4e73df !important;
    }

    .input-group:focus-within .form-control,
    .input-group:focus-within .form-select {
        border-color: #86b7fe;
        background-color: #fff !important;
    }

    .btn-gradient-primary {
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        color: white;
        border: none;
        transition: transform 0.2s;
    }

        .btn-gradient-primary:hover {
            transform: translateY(-2px);
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

    .font-monospace {
        font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
</style>

@code {
    [SupplyParameterFromForm]
    private CreateInput Input { get; set; } = new();

    private List<string> Roles { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        // Load roles from database
        Roles = await RoleManager.Roles.Select(r => r.Name!).ToListAsync();
    }

    private async Task CreateUser()
    {
        var user = new ApplicationUser
        {
            UserName = Input.Email,
            Email = Input.Email,
            Name = Input.Name,
            StudentId = Input.StudentId
        };

        var result = await UserManager.CreateAsync(user, Input.Password);

        if (!result.Succeeded)
        {
            // Add errors to the specific fields if possible, usually handled by ValidationSummary
            return;
        }

        if (!string.IsNullOrEmpty(Input.Role))
        {
            await UserManager.AddToRoleAsync(user, Input.Role);
        }

        NavigationManager.NavigateTo("/users");
    }

    private class CreateInput
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = "";

        [Required]
        [StringLength(100, MinimumLength = 6, ErrorMessage = "Password must be at least 6 characters long.")]
        public string Password { get; set; } = "";

        [Required]
        public string Name { get; set; } = "";

        public string StudentId { get; set; } = "";

        public string Role { get; set; } = "";
    }
}